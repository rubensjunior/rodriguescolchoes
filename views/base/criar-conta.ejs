<!-- Wappler include head-page="layouts/main" fontawesome_5="cdn" bootstrap5="local" is="dmx-app" id="criarconta" appConnect="local" components="{dmxValidator:{},dmxPreloader:{},dmxFormatter:{},dmxBootstrap5Alert:{}}" -->
<dmx-preloader id="carregando" color="#0930ff" spinner="wave"></dmx-preloader>
<meta name="ac:route" content="/f/criar-conta">

<!-- Controle de Step -->
<dmx-value id="current_step" dmx-bind:value="1"></dmx-value>
<dmx-value id="total_steps" dmx-bind:value="3"></dmx-value>

<div class="container-fluid py-4">
    <!-- Step Indicators -->
    <div class="row justify-content-center">
        <div class="col-12 col-md-5 col-lg-5 col-xl-5">
            <div class="step-indicators d-flex justify-content-center align-items-center">
                <div class="step-item d-flex align-items-center">
                    <div class="step-circle" dmx-class:active="current_step.value >= 1" dmx-class:completed="current_step.value > 1">
                        <span dmx-show="current_step.value <= 1">1</span>
                        <i class="fas fa-check" dmx-show="current_step.value > 1"></i>
                    </div>
                    <span class="step-label d-none d-md-inline">Dados Pessoais</span>
                </div>

                <div class="step-line"></div>

                <div class="step-item d-flex align-items-center">
                    <div class="step-circle" dmx-class:active="current_step.value >= 2" dmx-class:completed="current_step.value > 2">
                        <span dmx-show="current_step.value <= 2">2</span>
                        <i class="fas fa-check" dmx-show="current_step.value > 2"></i>
                    </div>
                    <span class="step-label d-none d-md-inline">Dados do Veículo</span>
                </div>

                <div class="step-line"></div>

                <div class="step-item d-flex align-items-center">
                    <div class="step-circle" dmx-class:active="current_step.value >= 3">
                        <span>3</span>
                    </div>
                    <span class="step-label d-none d-md-inline">Finalizar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-2 p-md-2">
                    <form is="dmx-serverconnect-form" id="criar_conta_form" class="needs-validation" method="post" action="/api/colaborador/criar-conta" dmx-on:error="notificacoes.danger('Ocorreu um erro: '+lastError.status+lastError.message+lastError.response)" dmx-on:success="navegacao.goto('/f/login',true)">

                        <!-- STEP 1: Dados Pessoais -->
                        <div dmx-show="current_step.value == 1" class="step-content">
                            <div class="row g-3">
                                <!-- Nome Completo -->
                                <div class="col-12">
                                    <div class="form-group mb-2">
                                        <label for="nome_completo" class="form-label">Nome completo *</label>
                                        <input type="text" class="form-control" id="nome_completo" name="nome_completo" required data-msg-required="Por favor, digite seu nome completo" placeholder="Ex: João Silva Santos">
                                    </div>
                                </div>

                                <!-- CPF -->
                                <div class="col-12">
                                    <div class="form-group mb-2">
                                        <label for="cpf" class="form-label">CPF *</label>
                                        <input type="text" class="form-control" id="cpf" name="cpf" required="" data-msg-required="Por favor, digite seu CPF" pattern="\d{3}\.\d{3}\.\d{3}-\d{2}" data-msg-pattern="CPF deve estar no formato 000.000.000-00" placeholder="000.000.000-00" inputmode="numeric">
                                    </div>
                                </div>

                                <!-- Data de Nascimento -->

                                <!-- Email -->
                                <div class="col-12">
                                    <div class="form-group mb-2">
                                        <label for="email" class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="email" name="email" required data-msg-required="Por favor, digite seu email" data-rule-email="true" data-msg-email="Digite um email válido" placeholder="seuemail@exemplo.com">
                                    </div>
                                </div>

                                <!-- Telefone -->
                                <div class="col-12">
                                    <div class="form-group mb-2">
                                        <label for="telefone" class="form-label">Telefone *</label>
                                        <input type="tel" class="form-control" id="telefone" name="telefone" required data-msg-required="Por favor, digite seu telefone" pattern="\(\d{2}\) \d{4,5}-\d{4}" data-msg-pattern="Telefone deve estar no formato (00) 00000-0000" placeholder="(00) 00000-0000" maxlength="15" inputmode="tel">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 2: Dados do Veículo -->
                        <div dmx-show="current_step.value == 2" class="step-content">
                            <div class="row g-3">
                                <!-- Tipo do Veículo -->
                                <div class="col-12 col-md-6">
                                    <div class="form-group mb-2">
                                        <label for="tipo_veiculo" class="form-label">Tipo do veículo</label>
                                        <select id="tipo_veiculo" name="tipo_veiculo" class="form-select">
                                            <option value="" selected disabled>Selecione o tipo</option>
                                            <option value="carro">Carro</option>
                                            <option value="moto">Moto</option>
                                            <option value="caminhao">Caminhão</option>
                                            <option value="van">Van</option>
                                            <option value="outros">Outros</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Placa -->
                                <div class="col-12 col-md-6">
                                    <div class="form-group mb-2">
                                        <label for="placa" class="form-label">Placa do veículo</label>
                                        <input type="text" class="form-control" id="placa" name="placa" placeholder="ABC1234" style="text-transform: uppercase;">
                                    </div>
                                </div>

                                <!-- Modelo do Veículo -->
                                <div class="col-12 col-md-6">
                                    <div class="form-group mb-2">
                                        <label for="modelo_veiculo" class="form-label">Modelo</label>
                                        <input type="text" class="form-control" id="modelo_veiculo" name="modelo_veiculo" placeholder="Ex: Honda Civic, Yamaha Factor, etc.">
                                        <div class="form-text">Campo opcional</div>
                                    </div>
                                </div>

                                <!-- Ano do Veículo -->
                                <div class="col-12 col-md-6">
                                    <div class="form-group mb-2">
                                        <label for="ano_veiculo" class="form-label">Ano</label>
                                        <input type="number" class="form-control" id="ano_veiculo" name="ano_veiculo" placeholder="2020">
                                        <div class="form-text">Campo opcional</div>
                                    </div>
                                </div>

                                <!-- Cor do Veículo -->
                                <div class="col-12">
                                    <div class="form-group mb-2">
                                        <label for="cor_veiculo" class="form-label">Cor do veículo</label>
                                        <input type="text" class="form-control" id="cor_veiculo" name="cor_veiculo" placeholder="Ex: Branco, Prata, Azul">
                                        <div class="form-text">Campo opcional - ajuda na identificação</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 3: Finalizar -->
                        <div dmx-show="current_step.value == 3" class="step-content">
                            <!-- Resumo dos Dados -->
                            <div class="card bg-light border-0 mb-4">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">
                                        <i class="fas fa-user me-2"></i>Resumo dos Dados
                                    </h5>

                                    <div class="row g-3">
                                        <div class="col-12 col-md-6">
                                            <strong>Nome:</strong><br>
                                            <span dmx-text="nome_completo.value || 'Não informado'"></span>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <strong>CPF:</strong><br>
                                            <span dmx-text="cpf.value || 'Não informado'"></span>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <strong>Email:</strong><br>
                                            <span dmx-text="email.value || 'Não informado'"></span>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <strong>Telefone:</strong><br>
                                            <span dmx-text="telefone.value || 'Não informado'"></span>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <strong>Data de Nascimento:</strong><br>
                                            <span dmx-text="data_nascimento.value || 'Não informado'"></span>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <strong>Veículo:</strong><br>
                                            <span dmx-text="tipo_veiculo.value || 'Não informado'"></span>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <strong>Placa:</strong><br>
                                            <span dmx-text="placa.value || 'Não informado'"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Termos de Uso -->
                            <div class="form-group mb-4">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="aceitar_termos" name="aceitar_termos" value="1" required data-msg-required="Você deve concordar com os termos para continuar">
                                    <label class="form-check-label" for="aceitar_termos">
                                        Li e concordo com os <a href="#" class="text-primary fw-semibold">Termos de Uso</a>
                                        e <a href="#" class="text-primary fw-semibold">Política de Privacidade</a>
                                    </label>
                                </div>
                            </div>

                            <!-- Política de Dados -->
                            <div class="alert alert-info border-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Proteção de Dados:</strong> Seus dados pessoais serão utilizados apenas para
                                finalidade de entrega e comunicação relacionada aos nossos serviços, conforme nossa
                                Política de Privacidade.
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="form-navigation mt-4">
                            <!-- Step 1: Apenas botão "Próximo" -->
                            <div dmx-show="current_step.value == 1" class="d-grid">
                                <button type="button" class="btn btn-primary btn-lg" dmx-on:click="current_step.setValue(2)">
                                    Próximo<i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>

                            <!-- Step 2: Botões "Voltar" e "Próximo" -->
                            <div dmx-show="current_step.value == 2" class="row g-2 g-md-3">
                                <div class="col-6">
                                    <button type="button" class="btn btn-outline-secondary w-100" dmx-on:click="current_step.setValue(1)">
                                        <i class="fas fa-arrow-left me-1 d-none d-sm-inline"></i>
                                        <span class="d-none d-sm-inline">Voltar</span>
                                        <span class="d-sm-none"><i class="fas fa-arrow-left"></i></span>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn btn-primary w-100" dmx-on:click="current_step.setValue(3)">
                                        <span class="d-none d-sm-inline">Próximo</span>
                                        <span class="d-sm-none">Avançar</span>
                                        <i class="fas fa-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: Botões "Voltar" e "Criar Conta" -->
                            <div dmx-show="current_step.value == 3" class="row g-2 g-md-3">
                                <!-- Botão Voltar -->
                                <div class="col-6">
                                    <button type="button" class="btn btn-outline-secondary w-100" dmx-on:click="current_step.setValue(2)">
                                        <i class="fas fa-arrow-left me-1 d-none d-sm-inline"></i>
                                        <span class="d-none d-sm-inline">Voltar</span>
                                        <span class="d-sm-none"><i class="fas fa-arrow-left"></i></span>
                                    </button>
                                </div>
                                <!-- Botão Finalizar -->
                                <div class="col-6" dmx-show="current_step.value == 3">
                                    <button type="submit" class="btn btn-success w-100">
                                        <span dmx-hide="criar_conta_form.state.executing">
                                            <i class="fas fa-check me-1 d-none d-sm-inline"></i>
                                            <span class="d-none d-sm-inline">Criar Conta</span>
                                            <span class="d-sm-none">Criar</span>
                                        </span>
                                        <span dmx-show="criar_conta_form.state.executing">
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            <span class="d-none d-sm-inline">Criando...</span>
                                            <span class="d-sm-none">...</span>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Link para Login -->
                        <div class="text-center mt-4">
                            <p class="mb-0">
                                Já tem uma conta?
                                <a href="/f/login" class="text-primary fw-semibold" internal="true">Faça login aqui</a>
                            </p>
                        </div>

                    </form>

                    <!-- Mensagens de Status -->
                    <div class="mt-3">
                        <!-- Sucesso -->

                        <!-- Erro -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.js"></script>

<script>
    // Máscaras de input - APENAS FORMATAÇÃO
    // Função para formatar CPF
    function formatCPF(value) {
        // Remove todos os caracteres não numéricos
        const numbers = value.replace(/\D/g, '');
        
        // Aplica a formatação
        if (numbers.length <= 11) {
            return numbers
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        }
        return numbers.substring(0, 11)
            .replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    // Função para formatar telefone
    function formatTelefone(value) {
        // Remove todos os caracteres não numéricos
        const numbers = value.replace(/\D/g, '');
        
        // Aplica a formatação
        if (numbers.length <= 10) {
            // Telefone fixo (10 dígitos)
            return numbers
                .replace(/(\d{2})(\d)/, '($1) $2')
                .replace(/(\d{4})(\d)/, '$1-$2');
        } else {
            // Celular (11 dígitos)
            return numbers.substring(0, 11)
                .replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
    }

    // Função para formatar data
    function formatData(value) {
        // Remove todos os caracteres não numéricos
        const numbers = value.replace(/\D/g, '');
        
        // Aplica a formatação DD/MM/AAAA
        if (numbers.length <= 8) {
            return numbers
                .replace(/(\d{2})(\d)/, '$1/$2')
                .replace(/(\d{2})(\d)/, '$1/$2');
        }
        return numbers.substring(0, 8)
            .replace(/(\d{2})(\d{2})(\d{4})/, '$1/$2/$3');
    }

    // Função para formatar placa
    function formatPlaca(value) {
        // Remove todos os caracteres que não são letras ou números
        const alphanumeric = value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
        
        // Aplica formatação baseada no comprimento
        if (alphanumeric.length <= 7) {
            // Formato antigo: ABC1234
            return alphanumeric
                .replace(/([A-Z]{3})(\d)/, '$1$2')
                .replace(/([A-Z]{3})(\d{1,4})/, '$1$2');
        } else {
            // Formato Mercosul: ABC1D23
            return alphanumeric.substring(0, 7)
                .replace(/([A-Z]{3})(\d{1})([A-Z]{1})(\d{2})/, '$1$2$3$4');
        }
    }

    // Aplicar máscaras imediatamente e em múltiplos eventos
    function aplicarMascaras() {
        const cpfInput = document.getElementById('cpf');
        const telefoneInput = document.getElementById('telefone');
        const dataInput = document.getElementById('data_nascimento');
        const placaInput = document.getElementById('placa');
        
        if (cpfInput && !cpfInput.hasAttribute('data-mask-applied')) {
            cpfInput.addEventListener('input', function(e) {
                e.target.value = formatCPF(e.target.value);
            });
            cpfInput.setAttribute('data-mask-applied', 'true');
        }
        
        if (telefoneInput && !telefoneInput.hasAttribute('data-mask-applied')) {
            telefoneInput.addEventListener('input', function(e) {
                e.target.value = formatTelefone(e.target.value);
            });
            telefoneInput.setAttribute('data-mask-applied', 'true');
        }
        
        if (dataInput && !dataInput.hasAttribute('data-mask-applied')) {
            dataInput.addEventListener('input', function(e) {
                e.target.value = formatData(e.target.value);
            });
            dataInput.setAttribute('data-mask-applied', 'true');
        }
        
        if (placaInput && !placaInput.hasAttribute('data-mask-applied')) {
            placaInput.addEventListener('input', function(e) {
                e.target.value = formatPlaca(e.target.value);
            });
            placaInput.setAttribute('data-mask-applied', 'true');
        }
    }

    // Aplicar máscaras o mais cedo possível
    aplicarMascaras();
    
    // Fallback para jQuery Mask (manter compatibilidade)
    if (typeof $ !== 'undefined') {
        $(document).ready(function() {
            // Só aplica jQuery mask se as máscaras nativas não foram aplicadas
            if (!document.getElementById('cpf').hasAttribute('data-mask-applied')) {
                $('#cpf').mask('000.000.000-00');
            }
            if (!document.getElementById('telefone').hasAttribute('data-mask-applied')) {
                $('#telefone').mask('(00) 00000-0000');
            }
            if (!document.getElementById('data_nascimento').hasAttribute('data-mask-applied')) {
                $('#data_nascimento').mask('00/00/0000');
            }
            if (!document.getElementById('placa').hasAttribute('data-mask-applied')) {
                $('#placa').mask('AAA0000', {'translation': {'A': {pattern: /[A-Za-z]/}, '0': {pattern: /[0-9]/}}});
            }
        });
    }

    // Log para debug
    document.addEventListener('DOMContentLoaded', function() {
        aplicarMascaras(); // Garantir aplicação
        
        console.log('Página carregada');
        console.log('Formulário:', document.getElementById('criar_conta_form'));
        console.log('App Connect:', typeof dmx !== 'undefined' ? 'Carregado' : 'Não carregado');
        console.log('Máscaras aplicadas:', {
            cpf: document.getElementById('cpf').hasAttribute('data-mask-applied'),
            telefone: document.getElementById('telefone').hasAttribute('data-mask-applied'),
            data_nascimento: document.getElementById('data_nascimento').hasAttribute('data-mask-applied'),
            placa: document.getElementById('placa').hasAttribute('data-mask-applied')
        });
    });
    
    // Aplicar máscaras também quando App Connect carrega
    if (typeof dmx !== 'undefined') {
        dmx.ready(aplicarMascaras);
    }
    
    // Timeout como último recurso
    setTimeout(aplicarMascaras, 100);
    setTimeout(aplicarMascaras, 500);
    setTimeout(aplicarMascaras, 1000);
</script>