<!-- Wappler include head-page="layouts/mobile-portaria" fontawesome_5="cdn" bootstrap5="local" is="dmx-app" id="portaria" appConnect="local" components="{dmxBootstrap5Alert:{}}" -->

<dmx-value id="qrcode_id"></dmx-value>
<dmx-serverconnect id="colaborador_veiculo" noload="true" url="/api/portaria/buscar-colaborador"></dmx-serverconnect>
<dmx-serverconnect id="registro_entrada" noload="true" url="/api/portaria/entrada" dmx-on:error="notificacao.danger('Ocorreu um erro, entre em contato com o DTI.')" dmx-on:success="run([{run:{outputType:'text',action:`notificacao.success(\'Entrada registrada com sucesso!\')`}},{wait:{delay:2000}},{run:{outputType:'text',action:`navegacao.reload()`}}])"></dmx-serverconnect>
<dmx-serverconnect id="registro_saida" noload="true" url="/api/portaria/saida" dmx-on:error="notificacao.danger('Ocorreu um erro, entre em contato com o DTI.')" dmx-on:success="run([{run:{outputType:'text',action:`notificacao.success(\'Saída registrada com sucesso!\')`}},{wait:{delay:2000}},{run:{outputType:'text',action:`navegacao.reload()`}}])"></dmx-serverconnect>

<meta name="ac:route" content="/d/portaria">
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Layout Principal -->
<div class="vh-100 d-flex flex-column bg-light">

  <!-- Header com Informações da Sessão -->
  <div class="bg-primary text-white p-3 text-center">
    <h4 class="mb-2">
      <i class="fas fa-shield-alt me-2"></i>
      Sistema de Portaria
    </h4>
    <div class="row g-2" dmx-show="usuario_logado.data">
      <div class="col-12">
        <div class="bg-white bg-opacity-10 p-2 rounded">
          <small class="text-white-50 d-block">Agente de Portaria</small>
          <span class="h6 mb-0">{{usuario_logado.data.query_colaborador.nome_colaborador}}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Área Principal de Conteúdo -->
  <div class="flex-fill p-3">

    <!-- STEP 1: Scanner QR Code (oculto quando colaborador é encontrado) -->
    <div dmx-hide="colaborador_veiculo.data.query_colaborador">
      <!-- Scanner QR Code Full Width -->
      <div id="reader" class="w-100 mb-3"></div>

      <!-- Resultado do Scan -->
      <div class="alert alert-light border mb-3" dmx-show="qrcode_id.value">
        <div class="d-flex align-items-center">
          <i class="fas fa-check-circle text-success me-2"></i>
          <div class="flex-grow-1">
            <small class="text-muted d-block">QR Code Lido:</small>
            <span id="reader-result" class="fw-bold" dmx-text="qrcode_id.value"></span>
          </div>
        </div>
      </div>

      <!-- Botão Validar -->
      <div class="d-grid mb-3">
        <button class="btn btn-primary btn-lg" dmx-bind:disabled="!qrcode_id.value || colaborador_veiculo.state.executing" dmx-on:click="colaborador_veiculo.load({id_colaborador_buscado: qrcode_id.value})">
          <span dmx-hide="colaborador_veiculo.state.executing">
            <i class="fas fa-search me-2"></i>
            Validar Colaborador
          </span>
          <span dmx-show="colaborador_veiculo.state.executing">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Validando...
          </span>
        </button>
      </div>
    </div>

    <!-- STEP 2: Card de Informações do Colaborador -->
    <div class="card mb-3" dmx-show="colaborador_veiculo.data.query_colaborador">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-user-check me-2"></i>
          Colaborador Identificado
        </h5>
        <!-- Botão para voltar ao scanner -->
        <button class="btn btn-light btn-sm" dmx-on:click="colaborador_veiculo.reset(); qrcode_id.setValue('')">
          <i class="fas fa-arrow-left me-1"></i>
          Voltar
        </button>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <!-- Dados do Colaborador -->
          <div class="col-12">
            <div class="bg-light p-3 rounded">
              <div class="row g-2">
                <div class="col-6">
                  <small class="text-muted d-block">Nome:</small>
                  <span class="fw-bold" dmx-text="colaborador_veiculo.data.query_colaborador.nome_colaborador"></span>
                </div>
                <div class="col-6">
                  <small class="text-muted d-block">CPF:</small>
                  <span class="fw-bold" dmx-text="colaborador_veiculo.data.query_colaborador.cpf_colaborador"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Dados do Veículo -->
          <div class="col-12" dmx-show="colaborador_veiculo.data.query_colaborador.veiculos_colaboradores.length > 0">
            <div class="bg-light p-3 rounded">
              <div class="row g-2">
                <div class="col-6">
                  <small class="text-muted d-block">
                    <i class="fas fa-car me-1"></i>Veículo:
                  </small>
                  <span class="fw-bold" dmx-text="colaborador_veiculo.data.query_colaborador.veiculos_colaboradores[0].modelo_veiculo"></span>
                </div>
                <div class="col-6">
                  <small class="text-muted d-block">
                    <i class="fas fa-id-card me-1"></i>Placa:
                  </small>
                  <span class="fw-bold text-uppercase" dmx-text="colaborador_veiculo.data.query_colaborador.veiculos_colaboradores[0].placa_veiculo"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Botões de Ação -->
          <div class="col-12">
            <div class="row g-2">
              <div class="col-6">
                <button class="btn btn-success btn-lg w-100" dmx-bind:disabled="registro_entrada.state.executing || registro_saida.state.executing" dmx-on:click="registro_entrada.load({
                          id_agente_portaria: usuario_logado.data.query_colaborador.id_colaborador, 
                          id_colaborador: colaborador_veiculo.data.query_colaborador.id_colaborador, 
                          id_veiculo: colaborador_veiculo.data.query_colaborador.veiculos_colaboradores[0].id_veiculo_colaborador
                        })">
                  <span dmx-hide="registro_entrada.state.executing">
                    <i class="fas fa-sign-in-alt me-2"></i>
                    Entrada
                  </span>
                  <span dmx-show="registro_entrada.state.executing">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Registrando...
                  </span>
                </button>
              </div>
              <div class="col-6">
                <button class="btn btn-warning btn-lg w-100" dmx-bind:disabled="registro_entrada.state.executing || registro_saida.state.executing" dmx-on:click="registro_saida.load({
                          id_agente_portaria: usuario_logado.data.query_colaborador.id_colaborador, 
                          id_colaborador: colaborador_veiculo.data.query_colaborador.id_colaborador, 
                          id_veiculo: colaborador_veiculo.data.query_colaborador.veiculos_colaboradores[0].id_veiculo_colaborador
                        })">
                  <span dmx-hide="registro_saida.state.executing">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    Saída
                  </span>
                  <span dmx-show="registro_saida.state.executing">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Registrando...
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas de Sucesso/Erro -->




  </div>

  <!-- Footer -->
  <div class="border-top bg-white p-3 text-center">
    <small class="text-muted">
      <i class="fas fa-building me-1"></i>
      Rodrigues Colchões - Sistema de Portaria
    </small>
  </div>

</div>

<!-- Script do Scanner QR -->
<script>
  const qrCode = new Html5Qrcode("reader");

  qrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    function onScanSuccess(decodedText, decodedResult) {
      console.log("QR Code lido:", decodedText);
      
      // Atualiza o elemento de resultado
      const resultElement = document.getElementById("reader-result");
      if (resultElement) {
        resultElement.innerText = decodedText;
      }
      
      // Adiciona o ID lido na variável App Connect
      dmx.app.find('qrcode_id').set('value', decodedText);
    }
  ).catch(err => {
    console.error("Erro ao iniciar scanner:", err);
  });
</script>